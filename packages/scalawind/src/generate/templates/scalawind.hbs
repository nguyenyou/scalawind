package {{packageName}}

import scala.quoted.*
import scala.annotation.unused

case class Tailwind() {
  {{#each modifiers}}
  def {{this.name}}(@unused styles: Tailwind): Tailwind = Tailwind()
  {{/each}}
  def important(@unused styles: Tailwind): Tailwind = Tailwind()
  def i(@unused styles: Tailwind): Tailwind = Tailwind()
  def raw(@unused classString: String): Tailwind = Tailwind()
  def variant(selector: String, styles: Tailwind): Tailwind = Tailwind()
  def opacity(value: Int): Tailwind = Tailwind()
  def o(value: Int): Tailwind = Tailwind()
}

object tw {
  def apply(): Tailwind = Tailwind()
  {{#each standard}}
  {{this.doc}}
  def {{this.prop}}: Tailwind = Tailwind()
  {{/each}}
  {{#each arbitrary}}
  def {{this.methodName}}(value: String): Tailwind = Tailwind()
  {{/each}}
  {{#each modifiers}}
  def {{this.name}}(@unused styles: Tailwind): Tailwind = Tailwind()
  {{/each}}
  def important(@unused styles: Tailwind): Tailwind = Tailwind()
  def i(@unused styles: Tailwind): Tailwind = Tailwind()
  def raw(@unused classString: String): Tailwind = Tailwind()
  def variant(selector: String, styles: Tailwind): Tailwind = Tailwind()
}

extension (tailwind: Tailwind)
  {{#each standard}}
  {{this.doc}}
  def {{this.prop}}: Tailwind = Tailwind()
  {{/each}}
  {{#each arbitrary}}
  def {{this.methodName}}(value: String): Tailwind = Tailwind()
  {{/each}}


inline def sw(inline tailwind: Tailwind): String =
  ${ swImpl('tailwind) }

def swImpl(twStyleExpr: Expr[Tailwind])(using Quotes): Expr[String] = {
  import quotes.reflect.*

  def extractClassNames(term: Term): List[String] = term match {
    case Apply(Select(inner, name), List(styles)) =>
      val classes = extractClassNames(styles).map(clx => s"$name:$clx")
      extractClassNames(inner) ++ classes
    case Apply(Select(inner, name), List(Literal(StringConstant(value)))) if name.endsWith("_") =>
      extractClassNames(inner) :+ s"${name.replace("_", "-")}[$value]"
    case Apply(Select(inner, "opacity"), List(Literal(IntConstant(value)))) =>
      extractClassNames(inner).init :+ s"${extractClassNames(inner).last}/$value"
    case Apply(Select(inner, "o"), List(Literal(IntConstant(value)))) =>
      extractClassNames(inner).init :+ s"${extractClassNames(inner).last}/$value"
    case Apply(Select(inner, "variant"), List(Literal(StringConstant(selector)), styles)) =>
      val classes = extractClassNames(styles).map(clx => s"[$selector]:$clx")
      extractClassNames(inner) ++ classes
    case Apply(Select(Select(Ident("tw"), method), "raw"), List(Literal(StringConstant(classString)))) =>
      val methodClass = method.replace("_", "-")
      val rawClasses = classString.split("\\s+").toList
      methodClass :: rawClasses
    case Apply(Select(Ident("tw"), "raw"), List(Literal(StringConstant(classString)))) =>
      classString.split("\\s+").toList
    case Apply(Select(inner, "important"), List(styles)) =>
      val classes = extractClassNames(styles).map(clx => s"!$clx")
      extractClassNames(inner) ++ classes
    case Apply(Select(inner, "i"), List(styles)) =>
      val classes = extractClassNames(styles).map(clx => s"!$clx")
      extractClassNames(inner) ++ classes
    case Apply(Ident(name), List(inner)) =>
      extractClassNames(inner) :+ name.replace("_", "-").replace("$", "/").replace("dot", ".")
    case Inlined(_, _, inner) =>
      extractClassNames(inner)
    case Select(inner, name) =>
      extractClassNames(inner) :+ name.replace("_", "-").replace("$", "/").replace("dot", ".")
    case Ident("tailwind") =>
      Nil
    case Ident("tw") =>
      Nil
    case _ =>
      report.errorAndAbort(s"Unexpected term: $term")
  }

  val term = twStyleExpr.asTerm
  val classNames = extractClassNames(term)
  val combinedClasses = classNames.mkString(" ")
  {{#if previewCompliedResult}}
  report.info(combinedClasses)
  {{/if}}
  Expr(combinedClasses)
}
